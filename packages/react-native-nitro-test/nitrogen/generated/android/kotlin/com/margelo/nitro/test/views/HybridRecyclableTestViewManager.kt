///
/// HybridRecyclableTestViewManager.kt
/// This file was generated by nitrogen. DO NOT MODIFY THIS FILE.
/// https://github.com/mrousavy/nitro
/// Copyright Â© Marc Rousavy @ Margelo
///

package com.margelo.nitro.test.views

import android.view.View
import com.facebook.react.uimanager.ReactStylesDiffMap
import com.facebook.react.uimanager.SimpleViewManager
import com.facebook.react.uimanager.StateWrapper
import com.facebook.react.uimanager.ThemedReactContext
import com.margelo.nitro.test.*
import com.margelo.nitro.views.RecyclableView

/**
 * Represents the React Native `ViewManager` for the "RecyclableTestView" Nitro HybridView.
 */
open class HybridRecyclableTestViewManager: SimpleViewManager<View>() {
  private val views = hashMapOf<View, HybridRecyclableTestView>()

  override fun getName(): String {
    return "RecyclableTestView"
  }

  override fun createViewInstance(reactContext: ThemedReactContext): View {
    val hybridView = HybridRecyclableTestView(reactContext)
    val view = hybridView.view
    views[view] = hybridView
    return view
  }

  override fun onDropViewInstance(view: View) {
    super.onDropViewInstance(view)
    views.remove(view)
  }

  override fun updateState(view: View, props: ReactStylesDiffMap, stateWrapper: StateWrapper): Any? {
    val hybridView = views[view] ?: throw Error("Couldn't find view $view in local views table!")

    // 1. Update each prop individually
    hybridView.beforeUpdate()
    HybridRecyclableTestViewStateUpdater.updateViewProps(hybridView, stateWrapper)
    hybridView.afterUpdate()

    // 2. Continue in base View props
    return super.updateState(view, props, stateWrapper)
  }

  protected override fun setupViewRecycling() {
    if (RecyclableView::class.java.isAssignableFrom(HybridRecyclableTestView::class.java)) {
      // The base class enables view recycling:
      super.setupViewRecycling();
    } else {
      // Not calling super disables view recycling.
    }
  }

  protected override fun prepareToRecycleView(reactContext: ThemedReactContext, view: View): View? {
    val hybridView = views[view] ?: return null

    if (hybridView is RecyclableView) {
      // Recycle in it's implementation
      hybridView.prepareForRecycle()

      // Maybe update the view if it changed
      val maybeNewView = hybridView.view
      views[maybeNewView] = hybridView
      return maybeNewView
    } else {
      return null
    }
  }
}
