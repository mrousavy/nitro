#
# NitroTest+autolinking.cmake
# This file was generated by nitrogen. DO NOT MODIFY THIS FILE.
# https://github.com/mrousavy/nitro
# Copyright Â© Marc Rousavy @ Margelo
#

# This is a CMake file that adds all files generated by Nitrogen
# to the current CMake project.
#
# To use it, add this to your CMakeLists.txt:
# ```cmake
# include(${CMAKE_SOURCE_DIR}/../nitrogen/generated/android/NitroTest+autolinking.cmake)
# ```

# Define a flag to check if we are building properly
add_definitions(-DBUILDING_NITROTEST_WITH_GENERATED_CMAKE_PROJECT)

# Enable Raw Props parsing in react-native (for Nitro Views)
add_definitions(-DRN_SERIALIZABLE_STATE)

# Add all headers that were generated by Nitrogen
include_directories(
  "../nitrogen/generated/shared/c++"
  "../nitrogen/generated/android/c++"
  "../nitrogen/generated/android/"
)

# Add all .cpp sources that were generated by Nitrogen
target_sources(
  # CMake project name (Android C++ library name)
  NitroTest PRIVATE
  # Autolinking Setup
  ../nitrogen/generated/android/NitroTestOnLoad.cpp
  # Shared Nitrogen C++ sources
  ../nitrogen/generated/shared/c++/HybridBaseSpec.cpp
  ../nitrogen/generated/shared/c++/HybridChildSpec.cpp
  ../nitrogen/generated/shared/c++/HybridPlatformObjectSpec.cpp
  ../nitrogen/generated/shared/c++/HybridRecyclableTestViewSpec.cpp
  ../nitrogen/generated/shared/c++/views/HybridRecyclableTestViewComponent.cpp
  ../nitrogen/generated/shared/c++/HybridTestObjectCppSpec.cpp
  ../nitrogen/generated/shared/c++/HybridTestObjectSwiftKotlinSpec.cpp
  ../nitrogen/generated/shared/c++/HybridTestObjectRustSpec.cpp
  ../nitrogen/generated/shared/c++/HybridTestObjectRustSpecRust.cpp
  ../nitrogen/generated/shared/c++/HybridTestViewSpec.cpp
  ../nitrogen/generated/shared/c++/views/HybridTestViewComponent.cpp
  # Android-specific Nitrogen C++ sources
  ../nitrogen/generated/android/c++/JHybridBaseSpec.cpp
  ../nitrogen/generated/android/c++/JHybridChildSpec.cpp
  ../nitrogen/generated/android/c++/JNamedVariant.cpp
  ../nitrogen/generated/android/c++/JVariant_String_Double.cpp
  ../nitrogen/generated/android/c++/JHybridPlatformObjectSpec.cpp
  ../nitrogen/generated/android/c++/JHybridRecyclableTestViewSpec.cpp
  ../nitrogen/generated/android/c++/views/JHybridRecyclableTestViewStateUpdater.cpp
  ../nitrogen/generated/android/c++/JHybridTestObjectSwiftKotlinSpec.cpp
  ../nitrogen/generated/android/c++/JVariant_NullType_String.cpp
  ../nitrogen/generated/android/c++/JVariant_HybridTestObjectSwiftKotlinSpec_Person.cpp
  ../nitrogen/generated/android/c++/JVariant_Boolean_Double.cpp
  ../nitrogen/generated/android/c++/JVariant_______Unit_Double.cpp
  ../nitrogen/generated/android/c++/JVariant_Boolean_OldEnum.cpp
  ../nitrogen/generated/android/c++/JVariant_Boolean_WeirdNumbersEnum.cpp
  ../nitrogen/generated/android/c++/JVariant_Car_Person.cpp
  ../nitrogen/generated/android/c++/JVariant_HybridBaseSpec_OptionalWrapper.cpp
  ../nitrogen/generated/android/c++/JCoreTypesVariant.cpp
  ../nitrogen/generated/android/c++/JStringOrExternal.cpp
  ../nitrogen/generated/android/c++/JVariant_Boolean_DoubleArray_Array_String__String_Double.cpp
  ../nitrogen/generated/android/c++/JHybridTestViewSpec.cpp
  ../nitrogen/generated/android/c++/views/JHybridTestViewStateUpdater.cpp
)

# From node_modules/react-native/ReactAndroid/cmake-utils/folly-flags.cmake
# Used in node_modules/react-native/ReactAndroid/cmake-utils/ReactNative-application.cmake
target_compile_definitions(
  NitroTest PRIVATE
  -DFOLLY_NO_CONFIG=1
  -DFOLLY_HAVE_CLOCK_GETTIME=1
  -DFOLLY_USE_LIBCPP=1
  -DFOLLY_CFG_NO_COROUTINES=1
  -DFOLLY_MOBILE=1
  -DFOLLY_HAVE_RECVMMSG=1
  -DFOLLY_HAVE_PTHREAD=1
  # Once we target android-23 above, we can comment
  # the following line. NDK uses GNU style stderror_r() after API 23.
  -DFOLLY_HAVE_XSI_STRERROR_R=1
)

# Add all libraries required by the generated specs
find_package(fbjni REQUIRED) # <-- Used for communication between Java <-> C++
find_package(ReactAndroid REQUIRED) # <-- Used to set up React Native bindings (e.g. CallInvoker/TurboModule)
find_package(react-native-nitro-modules REQUIRED) # <-- Used to create all HybridObjects and use the Nitro core library

# Link all libraries together
target_link_libraries(
        NitroTest
        fbjni::fbjni                              # <-- Facebook C++ JNI helpers
        ReactAndroid::jsi                         # <-- RN: JSI
        react-native-nitro-modules::NitroModules  # <-- NitroModules Core :)
)

# Link react-native (different prefab between RN 0.75 and RN 0.76)
if(ReactAndroid_VERSION_MINOR GREATER_EQUAL 76)
    target_link_libraries(
        NitroTest
        ReactAndroid::reactnative                 # <-- RN: Native Modules umbrella prefab
    )
else()
    target_link_libraries(
        NitroTest
        ReactAndroid::react_nativemodule_core     # <-- RN: TurboModules Core
    )
endif()

# Build and link the Rust static library.
# cargo is invoked automatically during the build for the correct Android ABI.
set(NITRO_RUST_SRC_DIR "${CMAKE_SOURCE_DIR}/../nitrogen/generated/shared/rust")
if(NOT DEFINED NITRO_RUST_LIB_DIR)
  set(NITRO_RUST_LIB_DIR "${NITRO_RUST_SRC_DIR}/target/${ANDROID_ABI}")
endif()

# Map Android ABI to Rust target triple
if(ANDROID_ABI STREQUAL "arm64-v8a")
  set(RUST_TARGET "aarch64-linux-android")
elseif(ANDROID_ABI STREQUAL "armeabi-v7a")
  set(RUST_TARGET "armv7-linux-androideabi")
elseif(ANDROID_ABI STREQUAL "x86_64")
  set(RUST_TARGET "x86_64-linux-android")
elseif(ANDROID_ABI STREQUAL "x86")
  set(RUST_TARGET "i686-linux-android")
endif()

# Cargo requires CARGO_TARGET_<TRIPLE>_LINKER with the triple uppercased
# and hyphens replaced by underscores (e.g. AARCH64_LINUX_ANDROID)
string(TOUPPER "${RUST_TARGET}" RUST_TARGET_UPPER)
string(REPLACE "-" "_" RUST_TARGET_UPPER "${RUST_TARGET_UPPER}")

set(NITRO_RUST_LIB_OUTPUT "${NITRO_RUST_LIB_DIR}/libNitroTest_rust.a")

# Collect Rust source files so CMake re-runs cargo when they change
file(GLOB_RECURSE NITRO_RUST_SOURCES
  "${NITRO_RUST_SRC_DIR}/*.rs"
  "${NITRO_RUST_SRC_DIR}/Cargo.toml"
)

add_custom_command(
  OUTPUT ${NITRO_RUST_LIB_OUTPUT}
  COMMAND ${CMAKE_COMMAND} -E env
    "PATH=$ENV{HOME}/.cargo/bin:$ENV{PATH}"
    "CARGO_TARGET_DIR=${NITRO_RUST_SRC_DIR}/target"
    "CC=${CMAKE_C_COMPILER}"
    "AR=${CMAKE_AR}"
    "CARGO_TARGET_${RUST_TARGET_UPPER}_LINKER=${CMAKE_C_COMPILER}"
    cargo build --release --target ${RUST_TARGET}
  COMMAND ${CMAKE_COMMAND} -E make_directory ${NITRO_RUST_LIB_DIR}
  COMMAND ${CMAKE_COMMAND} -E copy
    "${NITRO_RUST_SRC_DIR}/target/${RUST_TARGET}/release/libNitroTest_rust.a"
    ${NITRO_RUST_LIB_OUTPUT}
  WORKING_DIRECTORY ${NITRO_RUST_SRC_DIR}
  DEPENDS ${NITRO_RUST_SOURCES}
  COMMENT "Building Rust library for ${ANDROID_ABI} (${RUST_TARGET})"
)
add_custom_target(NitroTest_rust_build DEPENDS ${NITRO_RUST_LIB_OUTPUT})

add_library(NitroTest_rust STATIC IMPORTED)
set_target_properties(NitroTest_rust PROPERTIES IMPORTED_LOCATION ${NITRO_RUST_LIB_OUTPUT})
add_dependencies(NitroTest_rust NitroTest_rust_build)
target_link_libraries(NitroTest NitroTest_rust)
