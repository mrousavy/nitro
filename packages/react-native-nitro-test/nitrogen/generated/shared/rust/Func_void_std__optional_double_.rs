//
// Func_void_std__optional_double_.rs
// This file was generated by nitrogen. DO NOT MODIFY THIS FILE.
// https://github.com/mrousavy/nitro
// Copyright Â© Marc Rousavy @ Margelo
//
#![allow(
    non_camel_case_types,
    non_snake_case,
    dead_code,
    unused_imports,
    clippy::needless_return,
    clippy::redundant_closure,
    clippy::new_without_default,
    clippy::useless_conversion
)]

use std::ffi;

/// FFI-safe wrapper for callback `Func_void_std__optional_double_`.
///
/// Wraps a C function pointer + userdata into a callable Rust struct.
/// The C++ side passes a function pointer and opaque userdata;
/// the Rust side can call it safely through this wrapper.
#[repr(C)]
pub struct Func_void_std__optional_double_ {
    fn_ptr: unsafe extern "C" fn(*mut std::ffi::c_void, *mut std::ffi::c_void),
    userdata: *mut std::ffi::c_void,
    destroy_fn: unsafe extern "C" fn(*mut std::ffi::c_void),
}

// Safety: The C++ side guarantees the function pointer and userdata
// are valid for the lifetime of this struct and are thread-safe.
unsafe impl Send for Func_void_std__optional_double_ {}
unsafe impl Sync for Func_void_std__optional_double_ {}

impl Func_void_std__optional_double_ {
    /// Create a new wrapper from a C function pointer, userdata, and destroy function.
    pub fn new(
        fn_ptr: unsafe extern "C" fn(*mut std::ffi::c_void, *mut std::ffi::c_void),
        userdata: *mut ffi::c_void,
        destroy_fn: unsafe extern "C" fn(*mut ffi::c_void),
    ) -> Self {
        Self {
            fn_ptr,
            userdata,
            destroy_fn,
        }
    }

    /// Call the wrapped function.
    pub unsafe fn call(&self, maybe: Option<f64>) {
        unsafe {
            (self.fn_ptr)(self.userdata, {
                #[repr(C)]
                struct __Opt {
                    has_value: u8,
                    value: f64,
                }
                let __opt: __Opt = match maybe {
                    Some(__v) => __Opt {
                        has_value: 1,
                        value: __v,
                    },
                    None => __Opt {
                        has_value: 0,
                        value: unsafe { std::mem::zeroed() }, /* SAFETY: value is never read when has_value=0; all FFI types are zero-safe */
                    },
                };
                Box::into_raw(Box::new(__opt)) as *mut std::ffi::c_void
            });
        }
    }
}

impl Drop for Func_void_std__optional_double_ {
    fn drop(&mut self) {
        unsafe {
            (self.destroy_fn)(self.userdata);
        }
    }
}
